"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GenericClusterProvider = exports.ClusterBuilder = exports.defaultOptions = exports.GenericClusterPropsConstraints = exports.FargateProfileConstraints = exports.AutoscalingNodeGroupConstraints = exports.ManagedNodeGroupConstraints = void 0;
exports.clusterBuilder = clusterBuilder;
exports.selectKubectlLayer = selectKubectlLayer;
const lambda_layer_kubectl_v25_1 = require("@aws-cdk/lambda-layer-kubectl-v25");
const lambda_layer_kubectl_v26_1 = require("@aws-cdk/lambda-layer-kubectl-v26");
const lambda_layer_kubectl_v27_1 = require("@aws-cdk/lambda-layer-kubectl-v27");
const lambda_layer_kubectl_v28_1 = require("@aws-cdk/lambda-layer-kubectl-v28");
const lambda_layer_kubectl_v29_1 = require("@aws-cdk/lambda-layer-kubectl-v29");
const lambda_layer_kubectl_v30_1 = require("@aws-cdk/lambda-layer-kubectl-v30");
const lambda_layer_kubectl_v31_1 = require("@aws-cdk/lambda-layer-kubectl-v31");
const lambda_layer_kubectl_v32_1 = require("@aws-cdk/lambda-layer-kubectl-v32");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const autoscaling = require("aws-cdk-lib/aws-autoscaling");
const ec2 = require("aws-cdk-lib/aws-ec2");
const eks = require("aws-cdk-lib/aws-eks");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const spi_1 = require("../spi");
const utils = require("../utils");
const constants = require("./constants");
const assert = require("assert");
function clusterBuilder() {
    return new ClusterBuilder();
}
/**
 * Function that contains logic to map the correct kunbectl layer based on the passed in version.
 * @param scope in whch the kubectl layer must be created
 * @param version EKS version
 * @returns ILayerVersion or undefined
 */
function selectKubectlLayer(scope, version) {
    switch (version.version) {
        case "1.25":
            return new lambda_layer_kubectl_v25_1.KubectlV25Layer(scope, "kubectllayer25");
        case "1.26":
            return new lambda_layer_kubectl_v26_1.KubectlV26Layer(scope, "kubectllayer26");
        case "1.27":
            return new lambda_layer_kubectl_v27_1.KubectlV27Layer(scope, "kubectllayer27");
        case "1.28":
            return new lambda_layer_kubectl_v28_1.KubectlV28Layer(scope, "kubectllayer28");
        case "1.29":
            return new lambda_layer_kubectl_v29_1.KubectlV29Layer(scope, "kubectllayer29");
        case "1.30":
            return new lambda_layer_kubectl_v30_1.KubectlV30Layer(scope, "kubectllayer30");
        case "1.31":
            return new lambda_layer_kubectl_v31_1.KubectlV31Layer(scope, "kubectllayer30");
        case "1.32":
            return new lambda_layer_kubectl_v32_1.KubectlV32Layer(scope, "kubectllayer32");
    }
    const minor = version.version.split('.')[1];
    if (minor && parseInt(minor, 10) > 31) {
        return new lambda_layer_kubectl_v30_1.KubectlV30Layer(scope, "kubectllayer31"); // for all versions above 1.30 use 1.30 kubectl (unless explicitly supported in CDK)
    }
    return undefined;
}
class ManagedNodeGroupConstraints {
    constructor() {
        /**
         * id can be no less than 1 character long, and no greater than 63 characters long due to DNS system limitations.
         * https://kubernetes.io/docs/concepts/overview/working-with-objects/names/
         */
        this.id = new utils.StringConstraint(1, 63);
        /**
        * nodes per node group has a soft limit of 450 nodes, and as little as 0. But we multiply that by a factor of 5 to 2250 in case
        * of situations of a hard limit request being accepted, and as a result the limit would be raised
        * https://docs.aws.amazon.com/eks/latest/userguide/service-quotas.html
        */
        this.minSize = new utils.NumberConstraint(0, 2250);
        /**
         * nodes per node group has a soft limit of 450 nodes, and as little as 0. But we multiply that by a factor of 5 to 2250 in case
         * of situations of a hard limit request being accepted, and as a result the limit would be raised
         * https://docs.aws.amazon.com/eks/latest/userguide/service-quotas.html
         */
        this.maxSize = new utils.NumberConstraint(0, 2250);
        /**
         * Nodes per node group has a soft limit of 450 nodes, and as little as 0. But we multiply that by a factor of 5 to 2250 in case
         * of situations of a hard limit request being accepted, and as a result the limit would be raised
         * https://docs.aws.amazon.com/eks/latest/userguide/service-quotas.html
         */
        this.desiredSize = new utils.NumberConstraint(0, 2250);
        /**
         * amiReleaseVersion can be no less than 1 character long, and no greater than 1024 characters long.
         * https://docs.aws.amazon.com/imagebuilder/latest/APIReference/API_Ami.html
         */
        this.amiReleaseVersion = new utils.StringConstraint(1, 1024);
    }
}
exports.ManagedNodeGroupConstraints = ManagedNodeGroupConstraints;
class AutoscalingNodeGroupConstraints {
    constructor() {
        /**
        * id can be no less than 1 character long, and no greater than 63 characters long due to DNS system limitations.
        * https://kubernetes.io/docs/concepts/overview/working-with-objects/names/
        */
        this.id = new utils.StringConstraint(1, 63);
        /**
        * Allowed range is 0 to 5000 inclusive.
        * https://kubernetes.io/docs/setup/best-practices/cluster-large/
        */
        this.minSize = new utils.NumberConstraint(0, 5000);
        /**
        * Allowed range is 0 to 5000 inclusive.
        * https://kubernetes.io/docs/setup/best-practices/cluster-large/
        */
        this.maxSize = new utils.NumberConstraint(0, 5000);
        /**
        * Allowed range is 0 to 5000 inclusive.
        * https://kubernetes.io/docs/setup/best-practices/cluster-large/
        */
        this.desiredSize = new utils.NumberConstraint(0, 5000);
    }
}
exports.AutoscalingNodeGroupConstraints = AutoscalingNodeGroupConstraints;
class FargateProfileConstraints {
    constructor() {
        /**
        * fargateProfileNames can be no less than 1 character long, and no greater than 63 characters long due to DNS system limitations.
        * https://kubernetes.io/docs/concepts/overview/working-with-objects/names/
        */
        this.fargateProfileName = new utils.StringConstraint(1, 63);
    }
}
exports.FargateProfileConstraints = FargateProfileConstraints;
class GenericClusterPropsConstraints {
    constructor() {
        /**
        * managedNodeGroups per cluster have a soft limit of 30 managed node groups per EKS cluster, and as little as 0. But we multiply that
        * by a factor of 5 to 150 in case of situations of a hard limit request being accepted, and as a result the limit would be raised.
        * https://docs.aws.amazon.com/eks/latest/userguide/service-quotas.html
        */
        this.managedNodeGroups = new utils.ArrayConstraint(0, 150);
        /**
        * autoscalingNodeGroups per cluster have a soft limit of 500 autoscaling node groups per EKS cluster, and as little as 0. But we multiply that
        * by a factor of 5 to 2500 in case of situations of a hard limit request being accepted, and as a result the limit would be raised.
        * https://docs.aws.amazon.com/autoscaling/ec2/userguide/ec2-auto-scaling-quotas.html
        */
        this.autoscalingNodeGroups = new utils.ArrayConstraint(0, 5000);
    }
}
exports.GenericClusterPropsConstraints = GenericClusterPropsConstraints;
exports.defaultOptions = {};
class ClusterBuilder {
    constructor() {
        this.props = {};
        this.privateCluster = false;
        this.managedNodeGroups = [];
        this.autoscalingNodeGroups = [];
        this.fargateProfiles = {};
        this.props = { ...this.props };
    }
    withCommonOptions(options) {
        this.props = { ...this.props, ...options };
        return this;
    }
    managedNodeGroup(...nodeGroups) {
        this.managedNodeGroups = this.managedNodeGroups.concat(nodeGroups);
        return this;
    }
    autoscalingGroup(...nodeGroups) {
        this.autoscalingNodeGroups = this.autoscalingNodeGroups.concat(nodeGroups);
        return this;
    }
    fargateProfile(name, options) {
        this.fargateProfiles[name] = options;
        return this;
    }
    version(version) {
        this.props = { ...this.props, version };
        return this;
    }
    build() {
        return new GenericClusterProvider({
            ...this.props,
            privateCluster: this.privateCluster,
            managedNodeGroups: this.managedNodeGroups,
            autoscalingNodeGroups: this.autoscalingNodeGroups,
            fargateProfiles: this.fargateProfiles
        });
    }
}
exports.ClusterBuilder = ClusterBuilder;
/**
 * Cluster provider implementation that supports multiple node groups.
 */
class GenericClusterProvider {
    constructor(props) {
        this.props = props;
        this.validateInput(props);
        assert(!(props.managedNodeGroups && props.managedNodeGroups.length > 0
            && props.autoscalingNodeGroups && props.autoscalingNodeGroups.length > 0), "Mixing managed and autoscaling node groups is not supported. Please file a request on GitHub to add this support if needed.");
    }
    /**
     * @override
     */
    createCluster(scope, vpc, secretsEncryptionKey, kubernetesVersion, clusterLogging, ipFamily) {
        var _a, _b, _c, _d, _e, _f, _g, _h;
        const id = scope.node.id;
        // Props for the cluster.
        const clusterName = (_a = this.props.clusterName) !== null && _a !== void 0 ? _a : id;
        const outputClusterName = true;
        if (!kubernetesVersion && !this.props.version) {
            throw new Error("Version was not specified by cluster builder or in cluster provider props, must be specified in one of these");
        }
        const version = kubernetesVersion || this.props.version || eks.KubernetesVersion.V1_30;
        let privateCluster = (_b = this.props.privateCluster) !== null && _b !== void 0 ? _b : utils.valueFromContext(scope, constants.PRIVATE_CLUSTER, false);
        privateCluster = privateCluster ? privateCluster === 'true' : false;
        let isolatedCluster = (_c = this.props.isolatedCluster) !== null && _c !== void 0 ? _c : utils.valueFromContext(scope, constants.ISOLATED_CLUSTER, false);
        isolatedCluster = isolatedCluster ? isolatedCluster === 'true' : false;
        const endpointAccess = (privateCluster === true) ? eks.EndpointAccess.PRIVATE : eks.EndpointAccess.PUBLIC_AND_PRIVATE;
        const vpcSubnets = (_d = this.props.vpcSubnets) !== null && _d !== void 0 ? _d : (isolatedCluster === true ? [{ subnetType: ec2.SubnetType.PRIVATE_ISOLATED }] : privateCluster === true ? [{ subnetType: ec2.SubnetType.PRIVATE_WITH_EGRESS }] : undefined);
        const mastersRole = (_e = this.props.mastersRole) !== null && _e !== void 0 ? _e : new aws_iam_1.Role(scope, `${clusterName}-AccessRole`, {
            assumedBy: new aws_iam_1.AccountRootPrincipal()
        });
        const kubectlLayer = this.getKubectlLayer(scope, version);
        const tags = this.props.tags;
        const defaultOptions = {
            vpc,
            secretsEncryptionKey,
            clusterName,
            clusterLogging,
            outputClusterName,
            version,
            vpcSubnets,
            endpointAccess,
            kubectlLayer,
            tags,
            mastersRole,
            defaultCapacity: 0, // we want to manage capacity ourselves
            defaultCapacityType: eks.DefaultCapacityType.NODEGROUP
        };
        const isolatedOptions = isolatedCluster ? {
            placeClusterHandlerInVpc: true,
            clusterHandlerEnvironment: { AWS_STS_REGIONAL_ENDPOINTS: "regional" },
            kubectlEnvironment: { AWS_STS_REGIONAL_ENDPOINTS: "regional" },
        } : {};
        const clusterOptions = { ...defaultOptions, ...isolatedOptions, ...this.props, version, ipFamily };
        // Create an EKS Cluster
        const cluster = this.internalCreateCluster(scope, id, clusterOptions);
        cluster.node.addDependency(vpc);
        const nodeGroups = [];
        (_f = this.props.managedNodeGroups) === null || _f === void 0 ? void 0 : _f.forEach(n => {
            const nodeGroup = this.addManagedNodeGroup(cluster, n);
            nodeGroups.push(nodeGroup);
        });
        const autoscalingGroups = [];
        (_g = this.props.autoscalingNodeGroups) === null || _g === void 0 ? void 0 : _g.forEach(n => {
            const autoscalingGroup = this.addAutoScalingGroup(cluster, n);
            autoscalingGroups.push(autoscalingGroup);
        });
        const fargateProfiles = Object.entries((_h = this.props.fargateProfiles) !== null && _h !== void 0 ? _h : {});
        const fargateConstructs = [];
        fargateProfiles === null || fargateProfiles === void 0 ? void 0 : fargateProfiles.forEach(([key, options]) => fargateConstructs.push(this.addFargateProfile(cluster, key, options)));
        return new spi_1.ClusterInfo(cluster, version, nodeGroups, autoscalingGroups, false, fargateConstructs);
    }
    /**
     * Template method that may be overridden by subclasses to create a specific cluster flavor (e.g. FargateCluster vs eks.Cluster)
     * @param scope
     * @param id
     * @param clusterOptions
     * @returns
     */
    internalCreateCluster(scope, id, clusterOptions) {
        return new eks.Cluster(scope, id, clusterOptions);
    }
    /**
     * Can be overridden to provide a custom kubectl layer.
     * @param scope
     * @param version
     * @returns
     */
    getKubectlLayer(scope, version) {
        return selectKubectlLayer(scope, version);
    }
    /**
     * Adds an autoscaling group to the cluster.
     * @param cluster
     * @param nodeGroup
     * @returns
     */
    addAutoScalingGroup(cluster, nodeGroup) {
        var _a, _b, _c, _d, _e, _f, _g;
        const machineImageType = (_a = nodeGroup.machineImageType) !== null && _a !== void 0 ? _a : eks.MachineImageType.AMAZON_LINUX_2;
        const instanceTypeContext = utils.valueFromContext(cluster, constants.INSTANCE_TYPE_KEY, constants.DEFAULT_INSTANCE_TYPE);
        const instanceType = (_b = nodeGroup.instanceType) !== null && _b !== void 0 ? _b : (typeof instanceTypeContext === 'string' ? new ec2.InstanceType(instanceTypeContext) : instanceTypeContext);
        const minSize = (_c = nodeGroup.minSize) !== null && _c !== void 0 ? _c : utils.valueFromContext(cluster, constants.MIN_SIZE_KEY, constants.DEFAULT_NG_MINSIZE);
        const maxSize = (_d = nodeGroup.maxSize) !== null && _d !== void 0 ? _d : utils.valueFromContext(cluster, constants.MAX_SIZE_KEY, constants.DEFAULT_NG_MAXSIZE);
        const desiredSize = (_e = nodeGroup.desiredSize) !== null && _e !== void 0 ? _e : utils.valueFromContext(cluster, constants.DESIRED_SIZE_KEY, minSize);
        const updatePolicy = (_f = nodeGroup.updatePolicy) !== null && _f !== void 0 ? _f : autoscaling.UpdatePolicy.rollingUpdate();
        // Create an autoscaling group
        return cluster.addAutoScalingGroupCapacity(nodeGroup.id, {
            ...nodeGroup,
            ...{
                autoScalingGroupName: (_g = nodeGroup.autoScalingGroupName) !== null && _g !== void 0 ? _g : nodeGroup.id,
                machineImageType,
                instanceType,
                minCapacity: minSize,
                maxCapacity: maxSize,
                desiredCapacity: desiredSize,
                updatePolicy,
                vpcSubnets: nodeGroup.nodeGroupSubnets,
            }
        });
    }
    /**
     * Adds a fargate profile to the cluster
     */
    addFargateProfile(cluster, name, profileOptions) {
        return cluster.addFargateProfile(name, profileOptions);
    }
    /**
     * Adds a managed node group to the cluster.
     * @param cluster
     * @param nodeGroup
     * @returns
     */
    addManagedNodeGroup(cluster, nodeGroup) {
        var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l;
        const capacityType = nodeGroup.nodeGroupCapacityType;
        const releaseVersion = nodeGroup.amiReleaseVersion;
        const instanceTypeContext = utils.valueFromContext(cluster, constants.INSTANCE_TYPE_KEY, constants.DEFAULT_INSTANCE_TYPE);
        const instanceTypes = (_a = nodeGroup.instanceTypes) !== null && _a !== void 0 ? _a : ([typeof instanceTypeContext === 'string' ? new ec2.InstanceType(instanceTypeContext) : instanceTypeContext]);
        const minSize = (_b = nodeGroup.minSize) !== null && _b !== void 0 ? _b : utils.valueFromContext(cluster, constants.MIN_SIZE_KEY, constants.DEFAULT_NG_MINSIZE);
        const maxSize = (_c = nodeGroup.maxSize) !== null && _c !== void 0 ? _c : utils.valueFromContext(cluster, constants.MAX_SIZE_KEY, constants.DEFAULT_NG_MAXSIZE);
        const desiredSize = (_d = nodeGroup.desiredSize) !== null && _d !== void 0 ? _d : utils.valueFromContext(cluster, constants.DESIRED_SIZE_KEY, minSize);
        // Create a managed node group.
        const nodegroupOptions = {
            ...nodeGroup,
            ...{
                nodegroupName: (_e = nodeGroup.nodegroupName) !== null && _e !== void 0 ? _e : nodeGroup.id,
                capacityType,
                instanceTypes,
                minSize,
                maxSize,
                desiredSize,
                releaseVersion,
                subnets: nodeGroup.nodeGroupSubnets
            }
        };
        if (nodeGroup.launchTemplate) {
            // Create launch template with provided launch template properties
            const lt = new ec2.LaunchTemplate(cluster, `${nodeGroup.id}-lt`, {
                blockDevices: nodeGroup.launchTemplate.blockDevices,
                machineImage: (_f = nodeGroup.launchTemplate) === null || _f === void 0 ? void 0 : _f.machineImage,
                securityGroup: nodeGroup.launchTemplate.securityGroup,
                userData: (_g = nodeGroup.launchTemplate) === null || _g === void 0 ? void 0 : _g.userData,
                requireImdsv2: (_h = nodeGroup.launchTemplate) === null || _h === void 0 ? void 0 : _h.requireImdsv2,
                httpPutResponseHopLimit: (_j = nodeGroup.launchTemplate) === null || _j === void 0 ? void 0 : _j.httpPutResponseHopLimit,
            });
            utils.setPath(nodegroupOptions, "launchTemplateSpec", {
                id: lt.launchTemplateId,
                version: lt.latestVersionNumber,
            });
            const tags = Object.entries((_k = nodeGroup.launchTemplate.tags) !== null && _k !== void 0 ? _k : {});
            tags.forEach(([key, options]) => aws_cdk_lib_1.Tags.of(lt).add(key, options));
            if ((_l = nodeGroup.launchTemplate) === null || _l === void 0 ? void 0 : _l.machineImage) {
                delete nodegroupOptions.amiType;
                delete nodegroupOptions.releaseVersion;
                delete nodeGroup.amiReleaseVersion;
            }
        }
        const result = cluster.addNodegroupCapacity(nodeGroup.id + "-ng", nodegroupOptions);
        if (nodeGroup.enableSsmPermissions) {
            result.role.addManagedPolicy(aws_iam_1.ManagedPolicy.fromAwsManagedPolicyName('AmazonSSMManagedInstanceCore'));
        }
        return result;
    }
    validateInput(props) {
        utils.validateConstraints(new GenericClusterPropsConstraints, GenericClusterProvider.name, props);
        if (props.managedNodeGroups != undefined)
            utils.validateConstraints(new ManagedNodeGroupConstraints, "ManagedNodeGroup", ...props.managedNodeGroups);
        if (props.autoscalingNodeGroups != undefined)
            utils.validateConstraints(new AutoscalingNodeGroupConstraints, "AutoscalingNodeGroups", ...props.autoscalingNodeGroups);
        if (props.fargateProfiles != undefined)
            utils.validateConstraints(new FargateProfileConstraints, "FargateProfiles", ...Object.values(props.fargateProfiles));
    }
}
exports.GenericClusterProvider = GenericClusterProvider;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJpYy1jbHVzdGVyLXByb3ZpZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbGliL2NsdXN0ZXItcHJvdmlkZXJzL2dlbmVyaWMtY2x1c3Rlci1wcm92aWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUF5QkEsd0NBRUM7QUFRRCxnREEyQkM7QUE3REQsZ0ZBQW9FO0FBQ3BFLGdGQUFvRTtBQUNwRSxnRkFBb0U7QUFDcEUsZ0ZBQW9FO0FBQ3BFLGdGQUFvRTtBQUNwRSxnRkFBb0U7QUFDcEUsZ0ZBQW9FO0FBQ3BFLGdGQUFvRTtBQUVwRSw2Q0FBbUM7QUFDbkMsMkRBQTJEO0FBQzNELDJDQUEyQztBQUMzQywyQ0FBMkM7QUFDM0MsaURBQWdGO0FBSWhGLGdDQUFzRDtBQUN0RCxrQ0FBa0M7QUFDbEMseUNBQXlDO0FBRXpDLGlDQUFrQztBQUdsQyxTQUFnQixjQUFjO0lBQzFCLE9BQU8sSUFBSSxjQUFjLEVBQUUsQ0FBQztBQUNoQyxDQUFDO0FBRUQ7Ozs7O0dBS0c7QUFDSCxTQUFnQixrQkFBa0IsQ0FBQyxLQUFnQixFQUFFLE9BQThCO0lBQy9FLFFBQU8sT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ3JCLEtBQUssTUFBTTtZQUNQLE9BQU8sSUFBSSwwQ0FBZSxDQUFDLEtBQUssRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1FBQ3hELEtBQUssTUFBTTtZQUNQLE9BQU8sSUFBSSwwQ0FBZSxDQUFDLEtBQUssRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1FBQ3hELEtBQUssTUFBTTtZQUNQLE9BQU8sSUFBSSwwQ0FBZSxDQUFDLEtBQUssRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1FBQ3hELEtBQUssTUFBTTtZQUNQLE9BQU8sSUFBSSwwQ0FBZSxDQUFDLEtBQUssRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1FBQ3hELEtBQUssTUFBTTtZQUNQLE9BQU8sSUFBSSwwQ0FBZSxDQUFDLEtBQUssRUFBRSxnQkFBZ0IsQ0FBQyxDQUFD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QUE4QixDQUFDLENBQUMsQ0FBQztRQUN6RyxDQUFDO1FBRUQsT0FBTyxNQUFNLENBQUM7SUFDbEIsQ0FBQztJQUVPLGFBQWEsQ0FBQyxLQUFrQztRQUVwRCxLQUFLLENBQUMsbUJBQW1CLENBQUMsSUFBSSw4QkFBOEIsRUFBRSxzQkFBc0IsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDbEcsSUFBSSxLQUFLLENBQUMsaUJBQWlCLElBQUksU0FBUztZQUNwQyxLQUFLLENBQUMsbUJBQW1CLENBQUMsSUFBSSwyQkFBMkIsRUFBRSxrQkFBa0IsRUFBRSxHQUFHLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBQy9HLElBQUksS0FBSyxDQUFDLHFCQUFxQixJQUFJLFNBQVM7WUFDeEMsS0FBSyxDQUFDLG1CQUFtQixDQUFDLElBQUksK0JBQStCLEVBQUUsdUJBQXVCLEVBQUUsR0FBRyxLQUFLLENBQUMscUJBQXFCLENBQUMsQ0FBQztRQUM1SCxJQUFJLEtBQUssQ0FBQyxlQUFzQixJQUFJLFNBQVM7WUFDekMsS0FBSyxDQUFDLG1CQUFtQixDQUFDLElBQUkseUJBQXlCLEVBQUUsaUJBQWlCLEVBQUUsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxlQUFzQixDQUFDLENBQUMsQ0FBQztJQUNwSSxDQUFDO0NBQ0o7QUEzTkQsd0RBMk5DIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQgeyBLdWJlY3RsVjI1TGF5ZXIgfSBmcm9tIFwiQGF3cy1jZGsvbGFtYmRhLWxheWVyLWt1YmVjdGwtdjI1XCI7XG5pbXBvcnQgeyBLdWJlY3RsVjI2TGF5ZXIgfSBmcm9tIFwiQGF3cy1jZGsvbGFtYmRhLWxheWVyLWt1YmVjdGwtdjI2XCI7XG5pbXBvcnQgeyBLdWJlY3RsVjI3TGF5ZXIgfSBmcm9tIFwiQGF3cy1jZGsvbGFtYmRhLWxheWVyLWt1YmVjdGwtdjI3XCI7XG5pbXBvcnQgeyBLdWJlY3RsVjI4TGF5ZXIgfSBmcm9tIFwiQGF3cy1jZGsvbGFtYmRhLWxheWVyLWt1YmVjdGwtdjI4XCI7XG5pbXBvcnQgeyBLdWJlY3RsVjI5TGF5ZXIgfSBmcm9tIFwiQGF3cy1jZGsvbGFtYmRhLWxheWVyLWt1YmVjdGwtdjI5XCI7XG5pbXBvcnQgeyBLdWJlY3RsVjMwTGF5ZXIgfSBmcm9tIFwiQGF3cy1jZGsvbGFtYmRhLWxheWVyLWt1YmVjdGwtdjMwXCI7XG5pbXBvcnQgeyBLdWJlY3RsVjMxTGF5ZXIgfSBmcm9tIFwiQGF3cy1jZGsvbGFtYmRhLWxheWVyLWt1YmVjdGwtdjMxXCI7XG5pbXBvcnQgeyBLdWJlY3RsVjMyTGF5ZXIgfSBmcm9tIFwiQGF3cy1jZGsvbGFtYmRhLWxheWVyLWt1YmVjdGwtdjMyXCI7XG5cbmltcG9ydCB7IFRhZ3MgfSBmcm9tIFwiYXdzLWNkay1saWJcIjtcbmltcG9ydCAqIGFzIGF1dG9zY2FsaW5nIGZyb20gJ2F3cy1jZGstbGliL2F3cy1hdXRvc2NhbGluZyc7XG5pbXBvcnQgKiBhcyBlYzIgZnJvbSBcImF3cy1jZGstbGliL2F3cy1lYzJcIjtcbmltcG9ydCAqIGFzIGVrcyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWVrc1wiO1xuaW1wb3J0IHsgQWNjb3VudFJvb3RQcmluY2lwYWwsIE1hbmFnZWRQb2xpY3ksIFJvbGUgfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWlhbVwiO1xuaW1wb3J0IHsgSUtleSB9IGZyb20gXCJhd3MtY2RrLWxpYi9hd3Mta21zXCI7XG5pbXBvcnQgeyBJTGF5ZXJWZXJzaW9uIH0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1sYW1iZGFcIjtcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgeyBDbHVzdGVySW5mbywgQ2x1c3RlclByb3ZpZGVyIH0gZnJvbSBcIi4uL3NwaVwiO1xuaW1wb3J0ICogYXMgdXRpbHMgZnJvbSBcIi4uL3V0aWxzXCI7XG5pbXBvcnQgKiBhcyBjb25zdGFudHMgZnJvbSAnLi9jb25zdGFudHMnO1xuaW1wb3J0IHsgQXV0b3NjYWxpbmdOb2RlR3JvdXAsIE1hbmFnZWROb2RlR3JvdXAgfSBmcm9tIFwiLi90eXBlc1wiO1xuaW1wb3J0IGFzc2VydCA9IHJlcXVpcmUoJ2Fzc2VydCcpO1xuXG5cbmV4cG9ydCBmdW5jdGlvbiBjbHVzdGVyQnVpbGRlcigpIHtcbiAgICByZXR1cm4gbmV3IENsdXN0ZXJCdWlsZGVyKCk7XG59XG5cbi8qKlxuICogRnVuY3Rpb24gdGhhdCBjb250YWlucyBsb2dpYyB0byBtYXAgdGhlIGNvcnJlY3Qga3VuYmVjdGwgbGF5ZXIgYmFzZWQgb24gdGhlIHBhc3NlZCBpbiB2ZXJzaW9uLlxuICogQHBhcmFtIHNjb3BlIGluIHdoY2ggdGhlIGt1YmVjdGwgbGF5ZXIgbXVzdCBiZSBjcmVhdGVkXG4gKiBAcGFyYW0gdmVyc2lvbiBFS1MgdmVyc2lvblxuICogQHJldHVybnMgSUxheWVyVmVyc2lvbiBvciB1bmRlZmluZWRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHNlbGVjdEt1YmVjdGxMYXllcihzY29wZTogQ29uc3RydWN0LCB2ZXJzaW9uOiBla3MuS3ViZXJuZXRlc1ZlcnNpb24pOiBJTGF5ZXJWZXJzaW9uIHwgdW5kZWZpbmVkIHtcbiAgICBzd2l0Y2godmVyc2lvbi52ZXJzaW9uKSB7XG4gICAgICAgIGNhc2UgXCIxLjI1XCI6XG4gICAgICAgICAgICByZXR1cm4gbmV3IEt1YmVjdGxWMjVMYXllcihzY29wZSwgXCJrdWJlY3RsbGF5ZXIyNVwiKTtcbiAgICAgICAgY2FzZSBcIjEuMjZcIjpcbiAgICAgICAgICAgIHJldHVybiBuZXcgS3ViZWN0bFYyNkxheWVyKHNjb3BlLCBcImt1YmVjdGxsYXllcjI2XCIpO1xuICAgICAgICBjYXNlIFwiMS4yN1wiOlxuICAgICAgICAgICAgcmV0dXJuIG5ldyBLdWJlY3RsVjI3TGF5ZXIoc2NvcGUsIFwia3ViZWN0bGxheWVyMjdcIik7XG4gICAgICAgIGNhc2UgXCIxLjI4XCI6XG4gICAgICAgICAgICByZXR1cm4gbmV3IEt1YmVjdGxWMjhMYXllcihzY29wZSwgXCJrdWJlY3RsbGF5ZXIyOFwiKTtcbiAgICAgICAgY2FzZSBcIjEuMjlcIjpcbiAgICAgICAgICAgIHJldHVybiBuZXcgS3ViZWN0bFYyOUxheWVyKHNjb3BlLCBcImt1YmVjdGxsYXllcjI5XCIpO1xuICAgICAgICBjYXNlIFwiMS4zMFwiOlxuICAgICAgICAgICAgcmV0dXJuIG5ldyBLdWJlY3RsVjMwTGF5ZXIoc2NvcGUsIFwia3ViZWN0bGxheWVyMzBcIik7XG4gICAgICAgIGNhc2UgXCIxLjMxXCI6XG4gICAgICAgICAgICByZXR1cm4gbmV3IEt1YmVjdGxWMzFMYXllcihzY29wZSwgXCJrdWJlY3RsbGF5ZXIzMFwiKTtcbiAgICAgICAgY2FzZSBcIjEuMzJcIjpcbiAgICAgICAgICAgIHJldHVybiBuZXcgS3ViZWN0bFYzMkxheWVyKHNjb3BlLCBcImt1YmVjdGxsYXllcjMyXCIpO1xuXG4gICAgfVxuXG4gICAgY29uc3QgbWlub3IgPSB2ZXJzaW9uLnZlcnNpb24uc3BsaXQoJy4nKVsxXTtcblxuICAgIGlmKG1pbm9yICYmIHBhcnNlSW50KG1pbm9yLCAxMCkgPiAzMSkge1xuICAgICAgICByZXR1cm4gbmV3IEt1YmVjdGxWMzBMYXllcihzY29wZSwgXCJrdWJlY3RsbGF5ZXIzMVwiKTsgLy8gZm9yIGFsbCB2ZXJzaW9ucyBhYm92ZSAxLjMwIHVzZSAxLjMwIGt1YmVjdGwgKHVubGVzcyBleHBsaWNpdGx5IHN1cHBvcnRlZCBpbiBDREspXG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG59XG4vKipcbiAqIFByb3BlcnRpZXMgZm9yIHRoZSBnZW5lcmljIGNsdXN0ZXIgcHJvdmlkZXIsIGNvbnRhaW5pbmcgZGVmaW5pdGlvbnMgb2YgbWFuYWdlZCBub2RlIGdyb3VwcyxcbiAqIGF1dG8tc2NhbGluZyBncm91cHMsIGZhcmdhdGUgcHJvZmlsZXMuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgR2VuZXJpY0NsdXN0ZXJQcm92aWRlclByb3BzIGV4dGVuZHMgUGFydGlhbDxla3MuQ2x1c3Rlck9wdGlvbnM+IHtcblxuICAgIC8qKlxuICAgICAqIFdoZXRoZXIgY2x1c3RlciBoYXMgaW50ZXJuZXQgYWNjZXNzLlxuICAgICAqL1xuICAgIGlzb2xhdGVkQ2x1c3Rlcj86IGJvb2xlYW4sXG5cbiAgICAvKipcbiAgICAgKiBXaGV0aGVyIEFQSSBzZXJ2ZXIgaXMgcHJpdmF0ZS5cbiAgICAgKi9cbiAgICBwcml2YXRlQ2x1c3Rlcj86IGJvb2xlYW4sXG5cbiAgICAvKipcbiAgICAgKiBBcnJheSBvZiBtYW5hZ2VkIG5vZGUgZ3JvdXBzLlxuICAgICAqL1xuICAgIG1hbmFnZWROb2RlR3JvdXBzPzogTWFuYWdlZE5vZGVHcm91cFtdO1xuXG4gICAgLyoqXG4gICAgICogQXJyYXkgb2YgYXV0b3NjYWxpbmcgbm9kZSBncm91cHMuXG4gICAgICovXG4gICAgYXV0b3NjYWxpbmdOb2RlR3JvdXBzPzogQXV0b3NjYWxpbmdOb2RlR3JvdXBbXTtcblxuICAgIC8qKlxuICAgICAqIEZhcmdhdGUgcHJvZmlsZXNcbiAgICAgKi9cbiAgICBmYXJnYXRlUHJvZmlsZXM/OiB7XG4gICAgICAgIFtrZXk6IHN0cmluZ106IGVrcy5GYXJnYXRlUHJvZmlsZU9wdGlvbnM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVGFncyBmb3IgdGhlIGNsdXN0ZXJcbiAgICAgKi9cbiAgICB0YWdzPzoge1xuICAgICAgICBba2V5OiBzdHJpbmddOiBzdHJpbmc7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgTWFuYWdlZE5vZGVHcm91cENvbnN0cmFpbnRzIGltcGxlbWVudHMgdXRpbHMuQ29uc3RyYWludHNUeXBlPE1hbmFnZWROb2RlR3JvdXA+IHtcbiAgICAvKipcbiAgICAgKiBpZCBjYW4gYmUgbm8gbGVzcyB0aGFuIDEgY2hhcmFjdGVyIGxvbmcsIGFuZCBubyBncmVhdGVyIHRoYW4gNjMgY2hhcmFjdGVycyBsb25nIGR1ZSB0byBETlMgc3lzdGVtIGxpbWl0YXRpb25zLlxuICAgICAqIGh0dHBzOi8va3ViZXJuZXRlcy5pby9kb2NzL2NvbmNlcHRzL292ZXJ2aWV3L3dvcmtpbmctd2l0aC1vYmplY3RzL25hbWVzL1xuICAgICAqL1xuICAgIGlkID0gbmV3IHV0aWxzLlN0cmluZ0NvbnN0cmFpbnQoMSwgNjMpO1xuXG4gICAgLyoqXG4gICAgKiBub2RlcyBwZXIgbm9kZSBncm91cCBoYXMgYSBzb2Z0IGxpbWl0IG9mIDQ1MCBub2RlcywgYW5kIGFzIGxpdHRsZSBhcyAwLiBCdXQgd2UgbXVsdGlwbHkgdGhhdCBieSBhIGZhY3RvciBvZiA1IHRvIDIyNTAgaW4gY2FzZVxuICAgICogb2Ygc2l0dWF0aW9ucyBvZiBhIGhhcmQgbGltaXQgcmVxdWVzdCBiZWluZyBhY2NlcHRlZCwgYW5kIGFzIGEgcmVzdWx0IHRoZSBsaW1pdCB3b3VsZCBiZSByYWlzZWRcbiAgICAqIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9la3MvbGF0ZXN0L3VzZXJndWlkZS9zZXJ2aWNlLXF1b3Rhcy5odG1sXG4gICAgKi9cbiAgICBtaW5TaXplID0gbmV3IHV0aWxzLk51bWJlckNvbnN0cmFpbnQoMCwgMjI1MCk7XG5cbiAgICAvKipcbiAgICAgKiBub2RlcyBwZXIgbm9kZSBncm91cCBoYXMgYSBzb2Z0IGxpbWl0IG9mIDQ1MCBub2RlcywgYW5kIGFzIGxpdHRsZSBhcyAwLiBCdXQgd2UgbXVsdGlwbHkgdGhhdCBieSBhIGZhY3RvciBvZiA1IHRvIDIyNTAgaW4gY2FzZVxuICAgICAqIG9mIHNpdHVhdGlvbnMgb2YgYSBoYXJkIGxpbWl0IHJlcXVlc3QgYmVpbmcgYWNjZXB0ZWQsIGFuZCBhcyBhIHJlc3VsdCB0aGUgbGltaXQgd291bGQgYmUgcmFpc2VkXG4gICAgICogaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2Vrcy9sYXRlc3QvdXNlcmd1aWRlL3NlcnZpY2UtcXVvdGFzLmh0bWxcbiAgICAgKi9cbiAgICBtYXhTaXplID0gbmV3IHV0aWxzLk51bWJlckNvbnN0cmFpbnQoMCwgMjI1MCk7XG5cbiAgICAvKipcbiAgICAgKiBOb2RlcyBwZXIgbm9kZSBncm91cCBoYXMgYSBzb2Z0IGxpbWl0IG9mIDQ1MCBub2RlcywgYW5kIGFzIGxpdHRsZSBhcyAwLiBCdXQgd2UgbXVsdGlwbHkgdGhhdCBieSBhIGZhY3RvciBvZiA1IHRvIDIyNTAgaW4gY2FzZVxuICAgICAqIG9mIHNpdHVhdGlvbnMgb2YgYSBoYXJkIGxpbWl0IHJlcXVlc3QgYmVpbmcgYWNjZXB0ZWQsIGFuZCBhcyBhIHJlc3VsdCB0aGUgbGltaXQgd291bGQgYmUgcmFpc2VkXG4gICAgICogaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2Vrcy9sYXRlc3QvdXNlcmd1aWRlL3NlcnZpY2UtcXVvdGFzLmh0bWxcbiAgICAgKi9cbiAgICBkZXNpcmVkU2l6ZSA9IG5ldyB1dGlscy5OdW1iZXJDb25zdHJhaW50KDAsIDIyNTApO1xuXG4gICAgLyoqXG4gICAgICogYW1pUmVsZWFzZVZlcnNpb24gY2FuIGJlIG5vIGxlc3MgdGhhbiAxIGNoYXJhY3RlciBsb25nLCBhbmQgbm8gZ3JlYXRlciB0aGFuIDEwMjQgY2hhcmFjdGVycyBsb25nLlxuICAgICAqIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9pbWFnZWJ1aWxkZXIvbGF0ZXN0L0FQSVJlZmVyZW5jZS9BUElfQW1pLmh0bWxcbiAgICAgKi9cbiAgICBhbWlSZWxlYXNlVmVyc2lvbiA9IG5ldyB1dGlscy5TdHJpbmdDb25zdHJhaW50KDEsIDEwMjQpO1xufVxuXG5leHBvcnQgY2xhc3MgQXV0b3NjYWxpbmdOb2RlR3JvdXBDb25zdHJhaW50cyBpbXBsZW1lbnRzIHV0aWxzLkNvbnN0cmFpbnRzVHlwZTxBdXRvc2NhbGluZ05vZGVHcm91cD4ge1xuICAgIC8qKlxuICAgICogaWQgY2FuIGJlIG5vIGxlc3MgdGhhbiAxIGNoYXJhY3RlciBsb25nLCBhbmQgbm8gZ3JlYXRlciB0aGFuIDYzIGNoYXJhY3RlcnMgbG9uZyBkdWUgdG8gRE5TIHN5c3RlbSBsaW1pdGF0aW9ucy5cbiAgICAqIGh0dHBzOi8va3ViZXJuZXRlcy5pby9kb2NzL2NvbmNlcHRzL292ZXJ2aWV3L3dvcmtpbmctd2l0aC1vYmplY3RzL25hbWVzL1xuICAgICovXG4gICAgaWQgPSBuZXcgdXRpbHMuU3RyaW5nQ29uc3RyYWludCgxLCA2Myk7XG5cbiAgICAvKipcbiAgICAqIEFsbG93ZWQgcmFuZ2UgaXMgMCB0byA1MDAwIGluY2x1c2l2ZS5cbiAgICAqIGh0dHBzOi8va3ViZXJuZXRlcy5pby9kb2NzL3NldHVwL2Jlc3QtcHJhY3RpY2VzL2NsdXN0ZXItbGFyZ2UvXG4gICAgKi9cbiAgICBtaW5TaXplID0gbmV3IHV0aWxzLk51bWJlckNvbnN0cmFpbnQoMCwgNTAwMCk7XG5cbiAgICAvKipcbiAgICAqIEFsbG93ZWQgcmFuZ2UgaXMgMCB0byA1MDAwIGluY2x1c2l2ZS5cbiAgICAqIGh0dHBzOi8va3ViZXJuZXRlcy5pby9kb2NzL3NldHVwL2Jlc3QtcHJhY3RpY2VzL2NsdXN0ZXItbGFyZ2UvXG4gICAgKi9cbiAgICBtYXhTaXplID0gbmV3IHV0aWxzLk51bWJlckNvbnN0cmFpbnQoMCwgNTAwMCk7XG5cbiAgICAvKipcbiAgICAqIEFsbG93ZWQgcmFuZ2UgaXMgMCB0byA1MDAwIGluY2x1c2l2ZS5cbiAgICAqIGh0dHBzOi8va3ViZXJuZXRlcy5pby9kb2NzL3NldHVwL2Jlc3QtcHJhY3RpY2VzL2NsdXN0ZXItbGFyZ2UvXG4gICAgKi9cbiAgICBkZXNpcmVkU2l6ZSA9IG5ldyB1dGlscy5OdW1iZXJDb25zdHJhaW50KDAsIDUwMDApO1xufVxuXG5leHBvcnQgY2xhc3MgRmFyZ2F0ZVByb2ZpbGVDb25zdHJhaW50cyBpbXBsZW1lbnRzIHV0aWxzLkNvbnN0cmFpbnRzVHlwZTxla3MuRmFyZ2F0ZVByb2ZpbGVPcHRpb25zPiB7XG4gICAgLyoqXG4gICAgKiBmYXJnYXRlUHJvZmlsZU5hbWVzIGNhbiBiZSBubyBsZXNzIHRoYW4gMSBjaGFyYWN0ZXIgbG9uZywgYW5kIG5vIGdyZWF0ZXIgdGhhbiA2MyBjaGFyYWN0ZXJzIGxvbmcgZHVlIHRvIEROUyBzeXN0ZW0gbGltaXRhdGlvbnMuXG4gICAgKiBodHRwczovL2t1YmVybmV0ZXMuaW8vZG9jcy9jb25jZXB0cy9vdmVydmlldy93b3JraW5nLXdpdGgtb2JqZWN0cy9uYW1lcy9cbiAgICAqL1xuICAgIGZhcmdhdGVQcm9maWxlTmFtZSA9IG5ldyB1dGlscy5TdHJpbmdDb25zdHJhaW50KDEsIDYzKTtcbn1cblxuZXhwb3J0IGNsYXNzIEdlbmVyaWNDbHVzdGVyUHJvcHNDb25zdHJhaW50cyBpbXBsZW1lbnRzIHV0aWxzLkNvbnN0cmFpbnRzVHlwZTxHZW5lcmljQ2x1c3RlclByb3ZpZGVyUHJvcHM+IHtcbiAgICAvKipcbiAgICAqIG1hbmFnZWROb2RlR3JvdXBzIHBlciBjbHVzdGVyIGhhdmUgYSBzb2Z0IGxpbWl0IG9mIDMwIG1hbmFnZWQgbm9kZSBncm91cHMgcGVyIEVLUyBjbHVzdGVyLCBhbmQgYXMgbGl0dGxlIGFzIDAuIEJ1dCB3ZSBtdWx0aXBseSB0aGF0XG4gICAgKiBieSBhIGZhY3RvciBvZiA1IHRvIDE1MCBpbiBjYXNlIG9mIHNpdHVhdGlvbnMgb2YgYSBoYXJkIGxpbWl0IHJlcXVlc3QgYmVpbmcgYWNjZXB0ZWQsIGFuZCBhcyBhIHJlc3VsdCB0aGUgbGltaXQgd291bGQgYmUgcmFpc2VkLlxuICAgICogaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2Vrcy9sYXRlc3QvdXNlcmd1aWRlL3NlcnZpY2UtcXVvdGFzLmh0bWxcbiAgICAqL1xuICAgIG1hbmFnZWROb2RlR3JvdXBzID0gbmV3IHV0aWxzLkFycmF5Q29uc3RyYWludCgwLCAxNTApO1xuICAgIC8qKlxuICAgICogYXV0b3NjYWxpbmdOb2RlR3JvdXBzIHBlciBjbHVzdGVyIGhhdmUgYSBzb2Z0IGxpbWl0IG9mIDUwMCBhdXRvc2NhbGluZyBub2RlIGdyb3VwcyBwZXIgRUtTIGNsdXN0ZXIsIGFuZCBhcyBsaXR0bGUgYXMgMC4gQnV0IHdlIG11bHRpcGx5IHRoYXRcbiAgICAqIGJ5IGEgZmFjdG9yIG9mIDUgdG8gMjUwMCBpbiBjYXNlIG9mIHNpdHVhdGlvbnMgb2YgYSBoYXJkIGxpbWl0IHJlcXVlc3QgYmVpbmcgYWNjZXB0ZWQsIGFuZCBhcyBhIHJlc3VsdCB0aGUgbGltaXQgd291bGQgYmUgcmFpc2VkLlxuICAgICogaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2F1dG9zY2FsaW5nL2VjMi91c2VyZ3VpZGUvZWMyLWF1dG8tc2NhbGluZy1xdW90YXMuaHRtbFxuICAgICovXG4gICAgYXV0b3NjYWxpbmdOb2RlR3JvdXBzID0gbmV3IHV0aWxzLkFycmF5Q29uc3RyYWludCgwLCA1MDAwKTtcbn1cblxuZXhwb3J0IGNvbnN0IGRlZmF1bHRPcHRpb25zID0ge1xufTtcblxuZXhwb3J0IGNsYXNzIENsdXN0ZXJCdWlsZGVyIHtcblxuICAgIHByaXZhdGUgcHJvcHM6IFBhcnRpYWw8R2VuZXJpY0NsdXN0ZXJQcm92aWRlclByb3BzPiA9IHt9O1xuICAgIHByaXZhdGUgcHJpdmF0ZUNsdXN0ZXIgPSBmYWxzZTtcbiAgICBwcml2YXRlIG1hbmFnZWROb2RlR3JvdXBzOiBNYW5hZ2VkTm9kZUdyb3VwW10gPSBbXTtcbiAgICBwcml2YXRlIGF1dG9zY2FsaW5nTm9kZUdyb3VwczogQXV0b3NjYWxpbmdOb2RlR3JvdXBbXSA9IFtdO1xuICAgIHByaXZhdGUgZmFyZ2F0ZVByb2ZpbGVzOiB7XG4gICAgICAgIFtrZXk6IHN0cmluZ106IGVrcy5GYXJnYXRlUHJvZmlsZU9wdGlvbnM7XG4gICAgfSA9IHt9O1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHRoaXMucHJvcHMgPSB7IC4uLnRoaXMucHJvcHMgfTtcbiAgICB9XG5cbiAgICB3aXRoQ29tbW9uT3B0aW9ucyhvcHRpb25zOiBQYXJ0aWFsPGVrcy5DbHVzdGVyT3B0aW9ucz4pOiB0aGlzIHtcbiAgICAgICAgdGhpcy5wcm9wcyA9IHsgLi4udGhpcy5wcm9wcywgLi4ub3B0aW9ucyB9O1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBtYW5hZ2VkTm9kZUdyb3VwKC4uLm5vZGVHcm91cHM6IE1hbmFnZWROb2RlR3JvdXBbXSk6IHRoaXMge1xuICAgICAgICB0aGlzLm1hbmFnZWROb2RlR3JvdXBzID0gdGhpcy5tYW5hZ2VkTm9kZUdyb3Vwcy5jb25jYXQobm9kZUdyb3Vwcyk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGF1dG9zY2FsaW5nR3JvdXAoLi4ubm9kZUdyb3VwczogQXV0b3NjYWxpbmdOb2RlR3JvdXBbXSk6IHRoaXMge1xuICAgICAgICB0aGlzLmF1dG9zY2FsaW5nTm9kZUdyb3VwcyA9IHRoaXMuYXV0b3NjYWxpbmdOb2RlR3JvdXBzLmNvbmNhdChub2RlR3JvdXBzKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgZmFyZ2F0ZVByb2ZpbGUobmFtZTogc3RyaW5nLCBvcHRpb25zOiBla3MuRmFyZ2F0ZVByb2ZpbGVPcHRpb25zKTogdGhpcyB7XG4gICAgICAgIHRoaXMuZmFyZ2F0ZVByb2ZpbGVzW25hbWVdID0gb3B0aW9ucztcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgdmVyc2lvbih2ZXJzaW9uOiBla3MuS3ViZXJuZXRlc1ZlcnNpb24pOiB0aGlzIHtcbiAgICAgICAgdGhpcy5wcm9wcyA9IHsgLi4udGhpcy5wcm9wcywgdmVyc2lvbiB9O1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBidWlsZCgpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBHZW5lcmljQ2x1c3RlclByb3ZpZGVyKHtcbiAgICAgICAgICAgIC4uLnRoaXMucHJvcHMsXG4gICAgICAgICAgICBwcml2YXRlQ2x1c3RlcjogdGhpcy5wcml2YXRlQ2x1c3RlcixcbiAgICAgICAgICAgIG1hbmFnZWROb2RlR3JvdXBzOiB0aGlzLm1hbmFnZWROb2RlR3JvdXBzLFxuICAgICAgICAgICAgYXV0b3NjYWxpbmdOb2RlR3JvdXBzOiB0aGlzLmF1dG9zY2FsaW5nTm9kZUdyb3VwcyxcbiAgICAgICAgICAgIGZhcmdhdGVQcm9maWxlczogdGhpcy5mYXJnYXRlUHJvZmlsZXNcbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG4vKipcbiAqIENsdXN0ZXIgcHJvdmlkZXIgaW1wbGVtZW50YXRpb24gdGhhdCBzdXBwb3J0cyBtdWx0aXBsZSBub2RlIGdyb3Vwcy5cbiAqL1xuZXhwb3J0IGNsYXNzIEdlbmVyaWNDbHVzdGVyUHJvdmlkZXIgaW1wbGVtZW50cyBDbHVzdGVyUHJvdmlkZXIge1xuXG4gICAgY29uc3RydWN0b3IocmVhZG9ubHkgcHJvcHM6IEdlbmVyaWNDbHVzdGVyUHJvdmlkZXJQcm9wcykge1xuXG4gICAgICAgIHRoaXMudmFsaWRhdGVJbnB1dChwcm9wcyk7XG5cbiAgICAgICAgYXNzZXJ0KCEocHJvcHMubWFuYWdlZE5vZGVHcm91cHMgJiYgcHJvcHMubWFuYWdlZE5vZGVHcm91cHMubGVuZ3RoID4gMFxuICAgICAgICAgICAgJiYgcHJvcHMuYXV0b3NjYWxpbmdOb2RlR3JvdXBzICYmIHByb3BzLmF1dG9zY2FsaW5nTm9kZUdyb3Vwcy5sZW5ndGggPiAwKSxcbiAgICAgICAgICAgIFwiTWl4aW5nIG1hbmFnZWQgYW5kIGF1dG9zY2FsaW5nIG5vZGUgZ3JvdXBzIGlzIG5vdCBzdXBwb3J0ZWQuIFBsZWFzZSBmaWxlIGEgcmVxdWVzdCBvbiBHaXRIdWIgdG8gYWRkIHRoaXMgc3VwcG9ydCBpZiBuZWVkZWQuXCIpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBvdmVycmlkZVxuICAgICAqL1xuICAgIGNyZWF0ZUNsdXN0ZXIoc2NvcGU6IENvbnN0cnVjdCwgdnBjOiBlYzIuSVZwYywgc2VjcmV0c0VuY3J5cHRpb25LZXk/OiBJS2V5LCBrdWJlcm5ldGVzVmVyc2lvbj86IGVrcy5LdWJlcm5ldGVzVmVyc2lvbiwgY2x1c3RlckxvZ2dpbmc/OiBla3MuQ2x1c3RlckxvZ2dpbmdUeXBlc1tdLCBpcEZhbWlseT86IGVrcy5JcEZhbWlseSk6IENsdXN0ZXJJbmZvIHtcbiAgICAgICAgY29uc3QgaWQgPSBzY29wZS5ub2RlLmlkO1xuXG4gICAgICAgIC8vIFByb3BzIGZvciB0aGUgY2x1c3Rlci5cbiAgICAgICAgY29uc3QgY2x1c3Rlck5hbWUgPSB0aGlzLnByb3BzLmNsdXN0ZXJOYW1lID8/IGlkO1xuICAgICAgICBjb25zdCBvdXRwdXRDbHVzdGVyTmFtZSA9IHRydWU7XG4gICAgICAgIGlmICgha3ViZXJuZXRlc1ZlcnNpb24gJiYgIXRoaXMucHJvcHMudmVyc2lvbikge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVmVyc2lvbiB3YXMgbm90IHNwZWNpZmllZCBieSBjbHVzdGVyIGJ1aWxkZXIgb3IgaW4gY2x1c3RlciBwcm92aWRlciBwcm9wcywgbXVzdCBiZSBzcGVjaWZpZWQgaW4gb25lIG9mIHRoZXNlXCIpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHZlcnNpb246IGVrcy5LdWJlcm5ldGVzVmVyc2lvbiA9IGt1YmVybmV0ZXNWZXJzaW9uIHx8IHRoaXMucHJvcHMudmVyc2lvbiB8fCBla3MuS3ViZXJuZXRlc1ZlcnNpb24uVjFfMzA7XG5cbiAgICAgICAgbGV0IHByaXZhdGVDbHVzdGVyID0gdGhpcy5wcm9wcy5wcml2YXRlQ2x1c3RlciA/PyB1dGlscy52YWx1ZUZyb21Db250ZXh0KHNjb3BlLCBjb25zdGFudHMuUFJJVkFURV9DTFVTVEVSLCBmYWxzZSk7XG4gICAgICAgIHByaXZhdGVDbHVzdGVyID0gcHJpdmF0ZUNsdXN0ZXIgPyBwcml2YXRlQ2x1c3RlciA9PT0gJ3RydWUnIDogZmFsc2U7XG4gICAgICAgIGxldCBpc29sYXRlZENsdXN0ZXIgPSB0aGlzLnByb3BzLmlzb2xhdGVkQ2x1c3RlciA/PyB1dGlscy52YWx1ZUZyb21Db250ZXh0KHNjb3BlLCBjb25zdGFudHMuSVNPTEFURURfQ0xVU1RFUiwgZmFsc2UpO1xuICAgICAgICBpc29sYXRlZENsdXN0ZXIgPSBpc29sYXRlZENsdXN0ZXIgPyBpc29sYXRlZENsdXN0ZXIgPT09ICd0cnVlJyA6IGZhbHNlO1xuXG4gICAgICAgIGNvbnN0IGVuZHBvaW50QWNjZXNzID0gKHByaXZhdGVDbHVzdGVyID09PSB0cnVlKSA/IGVrcy5FbmRwb2ludEFjY2Vzcy5QUklWQVRFIDogZWtzLkVuZHBvaW50QWNjZXNzLlBVQkxJQ19BTkRfUFJJVkFURTtcbiAgICAgICAgY29uc3QgdnBjU3VibmV0cyA9IHRoaXMucHJvcHMudnBjU3VibmV0cyA/PyAoaXNvbGF0ZWRDbHVzdGVyID09PSB0cnVlID8gW3sgc3VibmV0VHlwZTogZWMyLlN1Ym5ldFR5cGUuUFJJVkFURV9JU09MQVRFRCB9XSA6IHByaXZhdGVDbHVzdGVyID09PSB0cnVlID8gW3sgc3VibmV0VHlwZTogZWMyLlN1Ym5ldFR5cGUuUFJJVkFURV9XSVRIX0VHUkVTUyB9XSA6IHVuZGVmaW5lZCk7XG4gICAgICAgIGNvbnN0IG1hc3RlcnNSb2xlID0gdGhpcy5wcm9wcy5tYXN0ZXJzUm9sZSA/PyBuZXcgUm9sZShzY29wZSwgYCR7Y2x1c3Rlck5hbWV9LUFjY2Vzc1JvbGVgLCB7XG4gICAgICAgICAgICBhc3N1bWVkQnk6IG5ldyBBY2NvdW50Um9vdFByaW5jaXBhbCgpXG4gICAgICAgIH0pO1xuXG5cbiAgICAgICAgY29uc3Qga3ViZWN0bExheWVyID0gdGhpcy5nZXRLdWJlY3RsTGF5ZXIoc2NvcGUsIHZlcnNpb24pO1xuICAgICAgICBjb25zdCB0YWdzID0gdGhpcy5wcm9wcy50YWdzO1xuXG4gICAgICAgIGNvbnN0IGRlZmF1bHRPcHRpb25zOiBQYXJ0aWFsPGVrcy5DbHVzdGVyUHJvcHM+ID0ge1xuICAgICAgICAgICAgdnBjLFxuICAgICAgICAgICAgc2VjcmV0c0VuY3J5cHRpb25LZXksXG4gICAgICAgICAgICBjbHVzdGVyTmFtZSxcbiAgICAgICAgICAgIGNsdXN0ZXJMb2dnaW5nLFxuICAgICAgICAgICAgb3V0cHV0Q2x1c3Rlck5hbWUsXG4gICAgICAgICAgICB2ZXJzaW9uLFxuICAgICAgICAgICAgdnBjU3VibmV0cyxcbiAgICAgICAgICAgIGVuZHBvaW50QWNjZXNzLFxuICAgICAgICAgICAga3ViZWN0bExheWVyLFxuICAgICAgICAgICAgdGFncyxcbiAgICAgICAgICAgIG1hc3RlcnNSb2xlLFxuICAgICAgICAgICAgZGVmYXVsdENhcGFjaXR5OiAwLCAvLyB3ZSB3YW50IHRvIG1hbmFnZSBjYXBhY2l0eSBvdXJzZWx2ZXNcbiAgICAgICAgICAgIGRlZmF1bHRDYXBhY2l0eVR5cGU6IGVrcy5EZWZhdWx0Q2FwYWNpdHlUeXBlLk5PREVHUk9VUFxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IGlzb2xhdGVkT3B0aW9uczogUGFydGlhbDxla3MuQ2x1c3RlclByb3BzPiA9IGlzb2xhdGVkQ2x1c3RlciA/IHtcbiAgICAgICAgICAgIHBsYWNlQ2x1c3RlckhhbmRsZXJJblZwYzogdHJ1ZSxcbiAgICAgICAgICAgIGNsdXN0ZXJIYW5kbGVyRW52aXJvbm1lbnQ6IHsgQVdTX1NUU19SRUdJT05BTF9FTkRQT0lOVFM6IFwicmVnaW9uYWxcIiB9LFxuICAgICAgICAgICAga3ViZWN0bEVudmlyb25tZW50OiB7IEFXU19TVFNfUkVHSU9OQUxfRU5EUE9JTlRTOiBcInJlZ2lvbmFsXCIgfSxcbiAgICAgICAgfSA6IHt9O1xuXG4gICAgICAgIGNvbnN0IGNsdXN0ZXJPcHRpb25zID0geyAuLi5kZWZhdWx0T3B0aW9ucywgLi4uaXNvbGF0ZWRPcHRpb25zLCAuLi50aGlzLnByb3BzLCB2ZXJzaW9uLCBpcEZhbWlseSB9O1xuXG4gICAgICAgIC8vIENyZWF0ZSBhbiBFS1MgQ2x1c3RlclxuICAgICAgICBjb25zdCBjbHVzdGVyID0gdGhpcy5pbnRlcm5hbENyZWF0ZUNsdXN0ZXIoc2NvcGUsIGlkLCBjbHVzdGVyT3B0aW9ucyk7XG4gICAgICAgIGNsdXN0ZXIubm9kZS5hZGREZXBlbmRlbmN5KHZwYyk7XG5cbiAgICAgICAgY29uc3Qgbm9kZUdyb3VwczogZWtzLk5vZGVncm91cFtdID0gW107XG5cbiAgICAgICAgdGhpcy5wcm9wcy5tYW5hZ2VkTm9kZUdyb3Vwcz8uZm9yRWFjaChuID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG5vZGVHcm91cCA9IHRoaXMuYWRkTWFuYWdlZE5vZGVHcm91cChjbHVzdGVyIGFzIGVrcy5DbHVzdGVyLCBuKTtcbiAgICAgICAgICAgIG5vZGVHcm91cHMucHVzaChub2RlR3JvdXApO1xuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBhdXRvc2NhbGluZ0dyb3VwczogYXV0b3NjYWxpbmcuQXV0b1NjYWxpbmdHcm91cFtdID0gW107XG4gICAgICAgIHRoaXMucHJvcHMuYXV0b3NjYWxpbmdOb2RlR3JvdXBzPy5mb3JFYWNoKG4gPT4ge1xuICAgICAgICAgICAgY29uc3QgYXV0b3NjYWxpbmdHcm91cCA9IHRoaXMuYWRkQXV0b1NjYWxpbmdHcm91cChjbHVzdGVyIGFzIGVrcy5DbHVzdGVyLCBuKTtcbiAgICAgICAgICAgIGF1dG9zY2FsaW5nR3JvdXBzLnB1c2goYXV0b3NjYWxpbmdHcm91cCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IGZhcmdhdGVQcm9maWxlcyA9IE9iamVjdC5lbnRyaWVzKHRoaXMucHJvcHMuZmFyZ2F0ZVByb2ZpbGVzID8/IHt9KTtcbiAgICAgICAgY29uc3QgZmFyZ2F0ZUNvbnN0cnVjdHM6IGVrcy5GYXJnYXRlUHJvZmlsZVtdID0gW107XG4gICAgICAgIGZhcmdhdGVQcm9maWxlcz8uZm9yRWFjaCgoW2tleSwgb3B0aW9uc10pID0+IGZhcmdhdGVDb25zdHJ1Y3RzLnB1c2godGhpcy5hZGRGYXJnYXRlUHJvZmlsZShjbHVzdGVyIGFzIGVrcy5DbHVzdGVyLCBrZXksIG9wdGlvbnMpKSk7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBDbHVzdGVySW5mbyhjbHVzdGVyLCB2ZXJzaW9uLCBub2RlR3JvdXBzLCBhdXRvc2NhbGluZ0dyb3VwcywgZmFsc2UsIGZhcmdhdGVDb25zdHJ1Y3RzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUZW1wbGF0ZSBtZXRob2QgdGhhdCBtYXkgYmUgb3ZlcnJpZGRlbiBieSBzdWJjbGFzc2VzIHRvIGNyZWF0ZSBhIHNwZWNpZmljIGNsdXN0ZXIgZmxhdm9yIChlLmcuIEZhcmdhdGVDbHVzdGVyIHZzIGVrcy5DbHVzdGVyKVxuICAgICAqIEBwYXJhbSBzY29wZVxuICAgICAqIEBwYXJhbSBpZFxuICAgICAqIEBwYXJhbSBjbHVzdGVyT3B0aW9uc1xuICAgICAqIEByZXR1cm5zXG4gICAgICovXG4gICAgcHJvdGVjdGVkIGludGVybmFsQ3JlYXRlQ2x1c3RlcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBjbHVzdGVyT3B0aW9uczogYW55KTogZWtzLkNsdXN0ZXIge1xuICAgICAgICByZXR1cm4gbmV3IGVrcy5DbHVzdGVyKHNjb3BlLCBpZCwgY2x1c3Rlck9wdGlvbnMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENhbiBiZSBvdmVycmlkZGVuIHRvIHByb3ZpZGUgYSBjdXN0b20ga3ViZWN0bCBsYXllci5cbiAgICAgKiBAcGFyYW0gc2NvcGVcbiAgICAgKiBAcGFyYW0gdmVyc2lvblxuICAgICAqIEByZXR1cm5zXG4gICAgICovXG4gICAgcHJvdGVjdGVkIGdldEt1YmVjdGxMYXllcihzY29wZTogQ29uc3RydWN0LCB2ZXJzaW9uOiBla3MuS3ViZXJuZXRlc1ZlcnNpb24pOiBJTGF5ZXJWZXJzaW9uIHwgdW5kZWZpbmVkIHtcbiAgICAgICAgcmV0dXJuIHNlbGVjdEt1YmVjdGxMYXllcihzY29wZSwgdmVyc2lvbik7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkcyBhbiBhdXRvc2NhbGluZyBncm91cCB0byB0aGUgY2x1c3Rlci5cbiAgICAgKiBAcGFyYW0gY2x1c3RlclxuICAgICAqIEBwYXJhbSBub2RlR3JvdXBcbiAgICAgKiBAcmV0dXJuc1xuICAgICAqL1xuICAgIGFkZEF1dG9TY2FsaW5nR3JvdXAoY2x1c3RlcjogZWtzLkNsdXN0ZXIsIG5vZGVHcm91cDogQXV0b3NjYWxpbmdOb2RlR3JvdXApOiBhdXRvc2NhbGluZy5BdXRvU2NhbGluZ0dyb3VwIHtcbiAgICAgICAgY29uc3QgbWFjaGluZUltYWdlVHlwZSA9IG5vZGVHcm91cC5tYWNoaW5lSW1hZ2VUeXBlID8/IGVrcy5NYWNoaW5lSW1hZ2VUeXBlLkFNQVpPTl9MSU5VWF8yO1xuICAgICAgICBjb25zdCBpbnN0YW5jZVR5cGVDb250ZXh0ID0gdXRpbHMudmFsdWVGcm9tQ29udGV4dChjbHVzdGVyLCBjb25zdGFudHMuSU5TVEFOQ0VfVFlQRV9LRVksIGNvbnN0YW50cy5ERUZBVUxUX0lOU1RBTkNFX1RZUEUpO1xuICAgICAgICBjb25zdCBpbnN0YW5jZVR5cGUgPSBub2RlR3JvdXAuaW5zdGFuY2VUeXBlID8/ICh0eXBlb2YgaW5zdGFuY2VUeXBlQ29udGV4dCA9PT0gJ3N0cmluZycgPyBuZXcgZWMyLkluc3RhbmNlVHlwZShpbnN0YW5jZVR5cGVDb250ZXh0KSA6IGluc3RhbmNlVHlwZUNvbnRleHQpO1xuICAgICAgICBjb25zdCBtaW5TaXplID0gbm9kZUdyb3VwLm1pblNpemUgPz8gdXRpbHMudmFsdWVGcm9tQ29udGV4dChjbHVzdGVyLCBjb25zdGFudHMuTUlOX1NJWkVfS0VZLCBjb25zdGFudHMuREVGQVVMVF9OR19NSU5TSVpFKTtcbiAgICAgICAgY29uc3QgbWF4U2l6ZSA9IG5vZGVHcm91cC5tYXhTaXplID8/IHV0aWxzLnZhbHVlRnJvbUNvbnRleHQoY2x1c3RlciwgY29uc3RhbnRzLk1BWF9TSVpFX0tFWSwgY29uc3RhbnRzLkRFRkFVTFRfTkdfTUFYU0laRSk7XG4gICAgICAgIGNvbnN0IGRlc2lyZWRTaXplID0gbm9kZUdyb3VwLmRlc2lyZWRTaXplID8/IHV0aWxzLnZhbHVlRnJvbUNvbnRleHQoY2x1c3RlciwgY29uc3RhbnRzLkRFU0lSRURfU0laRV9LRVksIG1pblNpemUpO1xuICAgICAgICBjb25zdCB1cGRhdGVQb2xpY3kgPSBub2RlR3JvdXAudXBkYXRlUG9saWN5ID8/IGF1dG9zY2FsaW5nLlVwZGF0ZVBvbGljeS5yb2xsaW5nVXBkYXRlKCk7XG5cbiAgICAgICAgLy8gQ3JlYXRlIGFuIGF1dG9zY2FsaW5nIGdyb3VwXG4gICAgICAgIHJldHVybiBjbHVzdGVyLmFkZEF1dG9TY2FsaW5nR3JvdXBDYXBhY2l0eShub2RlR3JvdXAuaWQsIHtcbiAgICAgICAgICAgIC4uLm5vZGVHcm91cCxcbiAgICAgICAgICAgIC4uLiB7XG4gICAgICAgICAgICAgICAgYXV0b1NjYWxpbmdHcm91cE5hbWU6IG5vZGVHcm91cC5hdXRvU2NhbGluZ0dyb3VwTmFtZSA/PyBub2RlR3JvdXAuaWQsXG4gICAgICAgICAgICAgICAgbWFjaGluZUltYWdlVHlwZSxcbiAgICAgICAgICAgICAgICBpbnN0YW5jZVR5cGUsXG4gICAgICAgICAgICAgICAgbWluQ2FwYWNpdHk6IG1pblNpemUsXG4gICAgICAgICAgICAgICAgbWF4Q2FwYWNpdHk6IG1heFNpemUsXG4gICAgICAgICAgICAgICAgZGVzaXJlZENhcGFjaXR5OiBkZXNpcmVkU2l6ZSxcbiAgICAgICAgICAgICAgICB1cGRhdGVQb2xpY3ksXG4gICAgICAgICAgICAgICAgdnBjU3VibmV0czogbm9kZUdyb3VwLm5vZGVHcm91cFN1Ym5ldHMsXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZHMgYSBmYXJnYXRlIHByb2ZpbGUgdG8gdGhlIGNsdXN0ZXJcbiAgICAgKi9cbiAgICBhZGRGYXJnYXRlUHJvZmlsZShjbHVzdGVyOiBla3MuQ2x1c3RlciwgbmFtZTogc3RyaW5nLCBwcm9maWxlT3B0aW9uczogZWtzLkZhcmdhdGVQcm9maWxlT3B0aW9ucyk6IGVrcy5GYXJnYXRlUHJvZmlsZSB7XG4gICAgICAgIHJldHVybiBjbHVzdGVyLmFkZEZhcmdhdGVQcm9maWxlKG5hbWUsIHByb2ZpbGVPcHRpb25zKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGRzIGEgbWFuYWdlZCBub2RlIGdyb3VwIHRvIHRoZSBjbHVzdGVyLlxuICAgICAqIEBwYXJhbSBjbHVzdGVyXG4gICAgICogQHBhcmFtIG5vZGVHcm91cFxuICAgICAqIEByZXR1cm5zXG4gICAgICovXG4gICAgYWRkTWFuYWdlZE5vZGVHcm91cChjbHVzdGVyOiBla3MuQ2x1c3Rlciwgbm9kZUdyb3VwOiBNYW5hZ2VkTm9kZUdyb3VwKTogZWtzLk5vZGVncm91cCB7XG4gICAgICAgIGNvbnN0IGNhcGFjaXR5VHlwZSA9IG5vZGVHcm91cC5ub2RlR3JvdXBDYXBhY2l0eVR5cGU7XG4gICAgICAgIGNvbnN0IHJlbGVhc2VWZXJzaW9uID0gbm9kZUdyb3VwLmFtaVJlbGVhc2VWZXJzaW9uO1xuICAgICAgICBjb25zdCBpbnN0YW5jZVR5cGVDb250ZXh0ID0gdXRpbHMudmFsdWVGcm9tQ29udGV4dChjbHVzdGVyLCBjb25zdGFudHMuSU5TVEFOQ0VfVFlQRV9LRVksIGNvbnN0YW50cy5ERUZBVUxUX0lOU1RBTkNFX1RZUEUpO1xuICAgICAgICBjb25zdCBpbnN0YW5jZVR5cGVzID0gbm9kZUdyb3VwLmluc3RhbmNlVHlwZXMgPz8gKFt0eXBlb2YgaW5zdGFuY2VUeXBlQ29udGV4dCA9PT0gJ3N0cmluZycgPyBuZXcgZWMyLkluc3RhbmNlVHlwZShpbnN0YW5jZVR5cGVDb250ZXh0KSA6IGluc3RhbmNlVHlwZUNvbnRleHRdKTtcbiAgICAgICAgY29uc3QgbWluU2l6ZSA9IG5vZGVHcm91cC5taW5TaXplID8/IHV0aWxzLnZhbHVlRnJvbUNvbnRleHQoY2x1c3RlciwgY29uc3RhbnRzLk1JTl9TSVpFX0tFWSwgY29uc3RhbnRzLkRFRkFVTFRfTkdfTUlOU0laRSk7XG4gICAgICAgIGNvbnN0IG1heFNpemUgPSBub2RlR3JvdXAubWF4U2l6ZSA/PyB1dGlscy52YWx1ZUZyb21Db250ZXh0KGNsdXN0ZXIsIGNvbnN0YW50cy5NQVhfU0laRV9LRVksIGNvbnN0YW50cy5ERUZBVUxUX05HX01BWFNJWkUpO1xuICAgICAgICBjb25zdCBkZXNpcmVkU2l6ZSA9IG5vZGVHcm91cC5kZXNpcmVkU2l6ZSA/PyB1dGlscy52YWx1ZUZyb21Db250ZXh0KGNsdXN0ZXIsIGNvbnN0YW50cy5ERVNJUkVEX1NJWkVfS0VZLCBtaW5TaXplKTtcblxuICAgICAgICAvLyBDcmVhdGUgYSBtYW5hZ2VkIG5vZGUgZ3JvdXAuXG4gICAgICAgIGNvbnN0IG5vZGVncm91cE9wdGlvbnM6IHV0aWxzLldyaXRlYWJsZTxla3MuTm9kZWdyb3VwT3B0aW9ucz4gPSB7XG4gICAgICAgICAgICAuLi5ub2RlR3JvdXAsXG4gICAgICAgICAgICAuLi57XG4gICAgICAgICAgICAgICAgbm9kZWdyb3VwTmFtZTogbm9kZUdyb3VwLm5vZGVncm91cE5hbWUgPz8gbm9kZUdyb3VwLmlkLFxuICAgICAgICAgICAgICAgIGNhcGFjaXR5VHlwZSxcbiAgICAgICAgICAgICAgICBpbnN0YW5jZVR5cGVzLFxuICAgICAgICAgICAgICAgIG1pblNpemUsXG4gICAgICAgICAgICAgICAgbWF4U2l6ZSxcbiAgICAgICAgICAgICAgICBkZXNpcmVkU2l6ZSxcbiAgICAgICAgICAgICAgICByZWxlYXNlVmVyc2lvbixcbiAgICAgICAgICAgICAgICBzdWJuZXRzOiBub2RlR3JvdXAubm9kZUdyb3VwU3VibmV0c1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIGlmIChub2RlR3JvdXAubGF1bmNoVGVtcGxhdGUpIHtcbiAgICAgICAgICAgIC8vIENyZWF0ZSBsYXVuY2ggdGVtcGxhdGUgd2l0aCBwcm92aWRlZCBsYXVuY2ggdGVtcGxhdGUgcHJvcGVydGllc1xuICAgICAgICAgICAgY29uc3QgbHQgPSBuZXcgZWMyLkxhdW5jaFRlbXBsYXRlKGNsdXN0ZXIsIGAke25vZGVHcm91cC5pZH0tbHRgLCB7XG4gICAgICAgICAgICAgICAgYmxvY2tEZXZpY2VzOiBub2RlR3JvdXAubGF1bmNoVGVtcGxhdGUuYmxvY2tEZXZpY2VzLFxuICAgICAgICAgICAgICAgIG1hY2hpbmVJbWFnZTogbm9kZUdyb3VwLmxhdW5jaFRlbXBsYXRlPy5tYWNoaW5lSW1hZ2UsXG4gICAgICAgICAgICAgICAgc2VjdXJpdHlHcm91cDogbm9kZUdyb3VwLmxhdW5jaFRlbXBsYXRlLnNlY3VyaXR5R3JvdXAsXG4gICAgICAgICAgICAgICAgdXNlckRhdGE6IG5vZGVHcm91cC5sYXVuY2hUZW1wbGF0ZT8udXNlckRhdGEsXG4gICAgICAgICAgICAgICAgcmVxdWlyZUltZHN2Mjogbm9kZUdyb3VwLmxhdW5jaFRlbXBsYXRlPy5yZXF1aXJlSW1kc3YyLFxuICAgICAgICAgICAgICAgIGh0dHBQdXRSZXNwb25zZUhvcExpbWl0OiBub2RlR3JvdXAubGF1bmNoVGVtcGxhdGU/Lmh0dHBQdXRSZXNwb25zZUhvcExpbWl0LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB1dGlscy5zZXRQYXRoKG5vZGVncm91cE9wdGlvbnMsIFwibGF1bmNoVGVtcGxhdGVTcGVjXCIsIHtcbiAgICAgICAgICAgICAgICBpZDogbHQubGF1bmNoVGVtcGxhdGVJZCEsXG4gICAgICAgICAgICAgICAgdmVyc2lvbjogbHQubGF0ZXN0VmVyc2lvbk51bWJlcixcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgY29uc3QgdGFncyA9IE9iamVjdC5lbnRyaWVzKG5vZGVHcm91cC5sYXVuY2hUZW1wbGF0ZS50YWdzID8/IHt9KTtcbiAgICAgICAgICAgIHRhZ3MuZm9yRWFjaCgoW2tleSwgb3B0aW9uc10pID0+IFRhZ3Mub2YobHQpLmFkZChrZXksIG9wdGlvbnMpKTtcbiAgICAgICAgICAgIGlmIChub2RlR3JvdXAubGF1bmNoVGVtcGxhdGU/Lm1hY2hpbmVJbWFnZSkge1xuICAgICAgICAgICAgICAgIGRlbGV0ZSBub2RlZ3JvdXBPcHRpb25zLmFtaVR5cGU7XG4gICAgICAgICAgICAgICAgZGVsZXRlIG5vZGVncm91cE9wdGlvbnMucmVsZWFzZVZlcnNpb247XG4gICAgICAgICAgICAgICAgZGVsZXRlIG5vZGVHcm91cC5hbWlSZWxlYXNlVmVyc2lvbjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGNsdXN0ZXIuYWRkTm9kZWdyb3VwQ2FwYWNpdHkobm9kZUdyb3VwLmlkICsgXCItbmdcIiwgbm9kZWdyb3VwT3B0aW9ucyk7XG5cbiAgICAgICAgaWYgKG5vZGVHcm91cC5lbmFibGVTc21QZXJtaXNzaW9ucykge1xuICAgICAgICAgICAgcmVzdWx0LnJvbGUuYWRkTWFuYWdlZFBvbGljeShNYW5hZ2VkUG9saWN5LmZyb21Bd3NNYW5hZ2VkUG9saWN5TmFtZSgnQW1hem9uU1NNTWFuYWdlZEluc3RhbmNlQ29yZScpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB2YWxpZGF0ZUlucHV0KHByb3BzOiBHZW5lcmljQ2x1c3RlclByb3ZpZGVyUHJvcHMpIHtcblxuICAgICAgICB1dGlscy52YWxpZGF0ZUNvbnN0cmFpbnRzKG5ldyBHZW5lcmljQ2x1c3RlclByb3BzQ29uc3RyYWludHMsIEdlbmVyaWNDbHVzdGVyUHJvdmlkZXIubmFtZSwgcHJvcHMpO1xuICAgICAgICBpZiAocHJvcHMubWFuYWdlZE5vZGVHcm91cHMgIT0gdW5kZWZpbmVkKVxuICAgICAgICAgICAgdXRpbHMudmFsaWRhdGVDb25zdHJhaW50cyhuZXcgTWFuYWdlZE5vZGVHcm91cENvbnN0cmFpbnRzLCBcIk1hbmFnZWROb2RlR3JvdXBcIiwgLi4ucHJvcHMubWFuYWdlZE5vZGVHcm91cHMpO1xuICAgICAgICBpZiAocHJvcHMuYXV0b3NjYWxpbmdOb2RlR3JvdXBzICE9IHVuZGVmaW5lZClcbiAgICAgICAgICAgIHV0aWxzLnZhbGlkYXRlQ29uc3RyYWludHMobmV3IEF1dG9zY2FsaW5nTm9kZUdyb3VwQ29uc3RyYWludHMsIFwiQXV0b3NjYWxpbmdOb2RlR3JvdXBzXCIsIC4uLnByb3BzLmF1dG9zY2FsaW5nTm9kZUdyb3Vwcyk7XG4gICAgICAgIGlmIChwcm9wcy5mYXJnYXRlUHJvZmlsZXMgYXMgYW55ICE9IHVuZGVmaW5lZClcbiAgICAgICAgICAgIHV0aWxzLnZhbGlkYXRlQ29uc3RyYWludHMobmV3IEZhcmdhdGVQcm9maWxlQ29uc3RyYWludHMsIFwiRmFyZ2F0ZVByb2ZpbGVzXCIsIC4uLk9iamVjdC52YWx1ZXMocHJvcHMuZmFyZ2F0ZVByb2ZpbGVzIGFzIGFueSkpO1xuICAgIH1cbn1cbiJdfQ==